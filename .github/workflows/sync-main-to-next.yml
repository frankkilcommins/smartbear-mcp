name: Sync Main to Next

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch all history for all branches
          fetch-depth: 0
          # Use a personal access token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync main to next
        run: |
          # Switch to next branch
          git checkout next

          # Get the current commit hash for logging
          NEXT_BEFORE=$(git rev-parse HEAD)
          echo "Next branch before sync: $NEXT_BEFORE"

          # Attempt to merge main into next
          if git merge origin/main --no-edit; then
            echo "âœ… Successfully merged main into next"

            # Push the updated next branch
            git push origin next
            echo "âœ… Successfully pushed updated next branch"

            # Log the new commit hash
            NEXT_AFTER=$(git rev-parse HEAD)
            echo "Next branch after sync: $NEXT_AFTER"

            # Set output for summary
            echo "SYNC_STATUS=success" >> $GITHUB_ENV
            echo "NEXT_BEFORE=$NEXT_BEFORE" >> $GITHUB_ENV
            echo "NEXT_AFTER=$NEXT_AFTER" >> $GITHUB_ENV
          else
            echo "âŒ Merge conflict detected!"
            echo "Manual intervention required to resolve conflicts between main and next branches."

            # Abort the merge
            git merge --abort

            # Set output for summary
            echo "SYNC_STATUS=conflict" >> $GITHUB_ENV

            # Exit with error to make the workflow fail
            exit 1
          fi

      - name: Create summary
        if: always()
        run: |
          if [ "$SYNC_STATUS" = "success" ]; then
            echo "## Branch Sync Complete âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Successfully synced changes from \`main\` to \`next\` branch." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details:" >> $GITHUB_STEP_SUMMARY
            echo "- **Source branch:** main" >> $GITHUB_STEP_SUMMARY
            echo "- **Target branch:** next" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger:** Push to main branch" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Next branch before:** \`${NEXT_BEFORE}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Next branch after:** \`${NEXT_AFTER}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "$SYNC_STATUS" = "conflict" ]; then
            echo "## Branch Sync Failed âŒ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Merge conflict detected!** Manual intervention required." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### What happened:" >> $GITHUB_STEP_SUMMARY
            echo "- Attempted to merge \`main\` into \`next\` branch" >> $GITHUB_STEP_SUMMARY
            echo "- Conflicts were detected that require manual resolution" >> $GITHUB_STEP_SUMMARY
            echo "- The merge was aborted to prevent data loss" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Manually checkout the \`next\` branch locally" >> $GITHUB_STEP_SUMMARY
            echo "2. Run \`git merge main\` to see the conflicts" >> $GITHUB_STEP_SUMMARY
            echo "3. Resolve the conflicts manually" >> $GITHUB_STEP_SUMMARY
            echo "4. Commit and push the resolved merge" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Trigger Details:" >> $GITHUB_STEP_SUMMARY
            echo "- **Source branch:** main" >> $GITHUB_STEP_SUMMARY
            echo "- **Target branch:** next" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## Branch Sync Status Unknown âš ï¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The sync process completed with an unknown status." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Issue on Conflict
        if: env.SYNC_STATUS == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Branch Sync Conflict: main â†’ next',
              body: `## Automatic Branch Sync Failed

              A merge conflict was detected when attempting to sync changes from \`main\` to \`next\` branch.

              **Trigger Commit:** ${context.sha}
              **Workflow Run:** [${context.runId}](${context.payload.repository.html_url}/actions/runs/${context.runId})

              ### Manual Resolution Required

              Please follow these steps to resolve the conflict:

              1. **Checkout the next branch locally:**
                 \`\`\`bash
                 git checkout next
                 git pull origin next
                 \`\`\`

              2. **Merge main and resolve conflicts:**
                 \`\`\`bash
                 git merge main
                 # Resolve any conflicts in your editor
                 git add .
                 git commit
                 \`\`\`

              3. **Push the resolved merge:**
                 \`\`\`bash
                 git push origin next
                 \`\`\`

              4. **Close this issue** once the sync is complete.

              ### Files Likely to Have Conflicts

              Check these common conflict areas:
              - \`package.json\` (version numbers)
              - \`CHANGELOG.md\` (release notes)
              - Configuration files
              - Documentation updates

              ---
              *This issue was automatically created by the [Sync Main to Next](.github/workflows/sync-main-to-next.yml) workflow.*`,
              labels: ['bug', 'automation', 'merge-conflict']
            });

            console.log('Created issue:', issue.data.html_url);
